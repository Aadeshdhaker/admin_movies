<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JavaGoat - Admin Panel</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .admin-page { display: none; }
        .admin-page.active { display: block; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans">

    <!-- Login Screen -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center">
        <div class="w-full max-w-md bg-gray-800 p-8 rounded-xl shadow-lg">
            <h1 class="text-3xl font-bold text-center mb-2">Java<span class="text-blue-500">Goat</span></h1>
            <p class="text-center text-gray-400 mb-6">Admin Panel</p>
            <form id="admin-login-form">
                <input type="email" id="admin-email" class="w-full bg-gray-700 text-white rounded p-3 mb-3 focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="Email" required>
                <input type="password" id="admin-password" class="w-full bg-gray-700 text-white rounded p-3 mb-4 focus:outline-none focus:ring-2 focus:ring-blue-600" placeholder="Password" required>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 rounded-lg p-3 font-semibold">Login</button>
                <p id="admin-auth-error" class="text-red-500 mt-4 text-center"></p>
            </form>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="admin-panel" class="hidden">
        <div class="flex h-screen">
            <!-- Sidebar -->
            <aside class="w-64 bg-gray-800 p-6 flex flex-col">
                <h1 class="text-2xl font-bold mb-8">Java<span class="text-blue-500">Goat</span></h1>
                <nav class="flex flex-col space-y-2">
                    <button data-page="dashboard" class="admin-nav-btn flex items-center p-3 rounded-lg bg-blue-600 text-white">
                        <i class="fas fa-tachometer-alt w-6"></i><span>Dashboard</span>
                    </button>
                    <button data-page="movies" class="admin-nav-btn flex items-center p-3 rounded-lg hover:bg-gray-700">
                        <i class="fas fa-film w-6"></i><span>Movies</span>
                    </button>
                    <button data-page="categories" class="admin-nav-btn flex items-center p-3 rounded-lg hover:bg-gray-700">
                        <i class="fas fa-th-list w-6"></i><span>Categories</span>
                    </button>
                    <button data-page="banners" class="admin-nav-btn flex items-center p-3 rounded-lg hover:bg-gray-700">
                        <i class="fas fa-images w-6"></i><span>Banners</span>
                    </button>
                </nav>
                <div class="mt-auto">
                    <button id="admin-logout-btn" class="w-full flex items-center p-3 rounded-lg hover:bg-red-700 text-red-400 hover:text-white">
                        <i class="fas fa-sign-out-alt w-6"></i><span>Logout</span>
                    </button>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 p-8 overflow-y-auto">
                
                <!-- Dashboard Page -->
                <div id="dashboard" class="admin-page active">
                    <h2 class="text-3xl font-bold mb-6">Dashboard</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="bg-gray-800 p-6 rounded-xl flex items-center">
                            <i class="fas fa-film text-blue-500 text-4xl mr-4"></i>
                            <div>
                                <p class="text-gray-400">Total Movies</p>
                                <p id="movies-count" class="text-3xl font-bold">0</p>
                            </div>
                        </div>
                         <div class="bg-gray-800 p-6 rounded-xl flex items-center">
                            <i class="fas fa-th-list text-blue-500 text-4xl mr-4"></i>
                            <div>
                                <p class="text-gray-400">Total Categories</p>
                                <p id="categories-count" class="text-3xl font-bold">0</p>
                            </div>
                        </div>
                         <div class="bg-gray-800 p-6 rounded-xl flex items-center">
                            <i class="fas fa-images text-blue-500 text-4xl mr-4"></i>
                            <div>
                                <p class="text-gray-400">Total Banners</p>
                                <p id="banners-count" class="text-3xl font-bold">0</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Movies Page -->
                <div id="movies" class="admin-page">
                    <h2 class="text-3xl font-bold mb-6">Manage Movies</h2>
                    <div class="bg-gray-800 p-6 rounded-xl">
                        <form id="movie-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <input type="hidden" id="movie-edit-id">
                            <input type="text" id="movie-title" placeholder="Title" class="bg-gray-700 p-3 rounded-lg" required>
                            <input type="number" id="movie-year" placeholder="Year" class="bg-gray-700 p-3 rounded-lg" required>
                            <input type="text" id="movie-poster" placeholder="Poster URL" class="bg-gray-700 p-3 rounded-lg col-span-2" required>
                            <input type="text" id="movie-watchlink" placeholder="Watch Link URL" class="bg-gray-700 p-3 rounded-lg col-span-2" required>
                            <input type="text" id="movie-rating" placeholder="Rating (e.g., 8.5)" class="bg-gray-700 p-3 rounded-lg">
                            <select id="movie-category" class="bg-gray-700 p-3 rounded-lg" required></select>
                            <input type="text" id="movie-cast" placeholder="Cast (comma-separated)" class="bg-gray-700 p-3 rounded-lg col-span-2">
                            <textarea id="movie-description" placeholder="Description" rows="4" class="bg-gray-700 p-3 rounded-lg col-span-2"></textarea>
                            <div class="col-span-2 flex space-x-4">
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-semibold">Save Movie</button>
                                <button type="button" id="movie-form-cancel" class="bg-gray-600 hover:bg-gray-500 px-6 py-2 rounded-lg font-semibold hidden">Cancel</button>
                            </div>
                        </form>
                    </div>
                    <div class="bg-gray-800 p-6 rounded-xl mt-6">
                        <table class="w-full text-left">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="p-3">Title</th><th class="p-3">Year</th><th class="p-3">Category</th><th class="p-3">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="movies-table"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Categories & Banners (Simplified CRUD) -->
                <div id="categories" class="admin-page">
                    <h2 class="text-3xl font-bold mb-6">Manage Categories</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-800 p-6 rounded-xl">
                            <h3 class="text-xl font-semibold mb-4">Add/Edit Category</h3>
                            <form id="category-form">
                                <input type="hidden" id="category-edit-id">
                                <input id="category-name" type="text" placeholder="Category Name" class="w-full bg-gray-700 p-3 rounded-lg mb-4" required>
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-semibold">Save Category</button>
                            </form>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-xl">
                            <h3 class="text-xl font-semibold mb-4">Existing Categories</h3>
                            <ul id="categories-list" class="space-y-2"></ul>
                        </div>
                    </div>
                </div>
                
                <div id="banners" class="admin-page">
                    <h2 class="text-3xl font-bold mb-6">Manage Banners</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-800 p-6 rounded-xl">
                            <h3 class="text-xl font-semibold mb-4">Add Banner</h3>
                            <form id="banner-form">
                                <input id="banner-url" type="text" placeholder="Banner Image URL" class="w-full bg-gray-700 p-3 rounded-lg mb-4" required>
                                <button type="submit" class="bg-blue-600 hover:bg-blue-700 px-6 py-2 rounded-lg font-semibold">Add Banner</button>
                            </form>
                        </div>
                        <div class="bg-gray-800 p-6 rounded-xl">
                            <h3 class="text-xl font-semibold mb-4">Current Banners</h3>
                            <div id="banners-list" class="grid grid-cols-2 gap-4"></div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>

    <script>
        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
  apiKey: "AIzaSyDjh_p7Jg--Ny8rqoZnlJQ1jeQIh35NuMc",
  authDomain: "movies-96e58.firebaseapp.com",
  databaseURL: "https://movies-96e58-default-rtdb.firebaseio.com",
  projectId: "movies-96e58",
  storageBucket: "movies-96e58.firebasestorage.app",
  messagingSenderId: "88627227696",
  appId: "1:88627227696:web:99435f815f4309034351f5"
};


        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // --- UI ELEMENTS ---
        const loginScreen = document.getElementById('login-screen');
        const adminPanel = document.getElementById('admin-panel');
        const adminPages = document.querySelectorAll('.admin-page');
        const adminNavBtns = document.querySelectorAll('.admin-nav-btn');

        // --- ADMIN AUTHENTICATION ---
        auth.onAuthStateChanged(user => {
            if (user) {
                loginScreen.style.display = 'none';
                adminPanel.classList.remove('hidden');
                initAdminPanel();
            } else {
                loginScreen.style.display = 'flex';
                adminPanel.classList.add('hidden');
            }
        });

        document.getElementById('admin-login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;
            auth.signInWithEmailAndPassword(email, password)
                .catch(err => document.getElementById('admin-auth-error').textContent = err.message);
        });

        document.getElementById('admin-logout-btn').addEventListener('click', () => auth.signOut());

        // --- ADMIN PANEL NAVIGATION ---
        const showAdminPage = (pageId) => {
            adminPages.forEach(p => p.classList.toggle('active', p.id === pageId));
            adminNavBtns.forEach(b => {
                b.classList.toggle('bg-blue-600', b.dataset.page === pageId);
                b.classList.toggle('text-white', b.dataset.page === pageId);
            });
        };
        adminNavBtns.forEach(b => b.addEventListener('click', () => showAdminPage(b.dataset.page)));
        
        // --- GENERIC CRUD FUNCTION ---
        const setupCrud = (entity, formId, listContainerId, renderListFn, getFormDataFn) => {
            const form = document.getElementById(formId);
            
            form.addEventListener('submit', (e) => {
                e.preventDefault();
                const formData = getFormDataFn();
                const editId = form.querySelector('input[type=hidden]')?.value;

                if (editId) {
                    // CRITICAL: Defensive check
                    if (!editId) return;
                    db.ref(`${entity}/${editId}`).update(formData).then(() => form.reset());
                } else {
                    db.ref(entity).push(formData).then(() => form.reset());
                }
            });

            db.ref(entity).on('value', snapshot => {
                const data = snapshot.val() || {};
                renderListFn(listContainerId, data);
            });
        };
        
        const deleteItem = (entity, id) => {
            // CRITICAL: Defensive check
            if (!id) {
                console.error(`Attempted to delete item with invalid ID from ${entity}`);
                return;
            }
            if (confirm('Are you sure you want to delete this item?')) {
                db.ref(`${entity}/${id}`).remove();
            }
        };

        // --- DASHBOARD ---
        const updateDashboard = () => {
            db.ref('movies').on('value', s => document.getElementById('movies-count').textContent = s.numChildren());
            db.ref('categories').on('value', s => document.getElementById('categories-count').textContent = s.numChildren());
            db.ref('banners').on('value', s => document.getElementById('banners-count').textContent = s.numChildren());
        };
        
        // --- MOVIES CRUD ---
        const movieForm = document.getElementById('movie-form');
        const movieCancelBtn = document.getElementById('movie-form-cancel');

        const resetMovieForm = () => {
            movieForm.reset();
            document.getElementById('movie-edit-id').value = '';
            movieCancelBtn.classList.add('hidden');
        }

        movieCancelBtn.addEventListener('click', resetMovieForm);
        
        const populateMovieForm = (id) => {
            // CRITICAL: Defensive check
            if (!id) return;
            db.ref(`movies/${id}`).once('value', snapshot => {
                const movie = snapshot.val();
                if (!movie) return;
                document.getElementById('movie-edit-id').value = id;
                document.getElementById('movie-title').value = movie.title || '';
                document.getElementById('movie-year').value = movie.year || '';
                document.getElementById('movie-poster').value = movie.posterUrl || '';
                document.getElementById('movie-watchlink').value = movie.watchLink || '';
                document.getElementById('movie-rating').value = movie.rating || '';
                document.getElementById('movie-category').value = movie.category || '';
                document.getElementById('movie-cast').value = movie.cast || '';
                document.getElementById('movie-description').value = movie.description || '';
                movieCancelBtn.classList.remove('hidden');
                window.scrollTo(0,0);
            });
        };

        setupCrud(
            'movies',
            'movie-form',
            'movies-table',
            (containerId, data) => { // Render Function
                const container = document.getElementById(containerId);
                container.innerHTML = Object.entries(data).map(([id, movie]) => `
                    <tr class="border-b border-gray-700 hover:bg-gray-700/50">
                        <td class="p-3">${movie.title}</td>
                        <td class="p-3">${movie.year}</td>
                        <td class="p-3">${movie.category}</td>
                        <td class="p-3">
                            <button onclick="populateMovieForm('${id}')" class="text-blue-400 hover:text-blue-300 mr-4"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteItem('movies', '${id}')" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('');
            },
            () => ({ // Get Form Data Function
                title: document.getElementById('movie-title').value,
                year: document.getElementById('movie-year').value,
                posterUrl: document.getElementById('movie-poster').value,
                watchLink: document.getElementById('movie-watchlink').value,
                rating: document.getElementById('movie-rating').value,
                category: document.getElementById('movie-category').value,
                cast: document.getElementById('movie-cast').value,
                description: document.getElementById('movie-description').value,
            })
        );
        movieForm.addEventListener('submit', resetMovieForm); // Reset form after successful submission
        

        // --- CATEGORIES CRUD ---
        setupCrud(
            'categories',
            'category-form',
            'categories-list',
            (containerId, data) => {
                document.getElementById(containerId).innerHTML = Object.entries(data).map(([id, cat]) => `
                    <li class="flex justify-between items-center bg-gray-700 p-2 rounded">
                        <span>${cat.name}</span>
                        <button onclick="deleteItem('categories', '${id}')" class="text-red-400 hover:text-red-300"><i class="fas fa-trash"></i></button>
                    </li>
                `).join('');
                 // Also populate movie category dropdown
                const movieCategorySelect = document.getElementById('movie-category');
                movieCategorySelect.innerHTML = '<option value="">Select Category</option>' + Object.values(data).map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            },
            () => ({ name: document.getElementById('category-name').value })
        );

        // --- BANNERS CRUD ---
        setupCrud(
            'banners',
            'banner-form',
            'banners-list',
            (containerId, data) => {
                document.getElementById(containerId).innerHTML = Object.entries(data).map(([id, banner]) => `
                    <div class="relative">
                        <img src="${banner.imageUrl}" class="w-full h-24 object-cover rounded-lg">
                        <button onclick="deleteItem('banners', '${id}')" class="absolute top-1 right-1 bg-red-600/80 w-6 h-6 rounded-full flex items-center justify-center text-white">&times;</button>
                    </div>
                `).join('');
            },
            () => ({ imageUrl: document.getElementById('banner-url').value })
        );

        // --- Initialize Panel ---
        function initAdminPanel() {
            showAdminPage('dashboard');
            updateDashboard();
        }
    </script>
</body>
</html>
